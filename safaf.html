<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель | Управление заявками</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/admin/main.css">
    <link rel="stylesheet" href="/static/css/admin/components/sidebar.css">
    <link rel="stylesheet" href="/static/css/admin/components/stats.css">
    <link rel="stylesheet" href="/static/css/admin/components/table.css">
    <link rel="stylesheet" href="/static/css/admin/components/modal.css">
    <link rel="stylesheet" href="/static/css/admin/utilities.css">
</head>
<body>
<div class="admin-container">
    <!-- Сайдбар -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon"><i class="fas fa-chart-line"></i></div>
            <div class="logo-text">Админ-панель</div>
        </div>
        <div class="nav-item active">
            <div class="nav-icon"><i class="fas fa-file-alt"></i></div>
            <div class="nav-text">Заявки</div>
        </div>
        <div class="nav-item">
            <div class="nav-icon"><i class="fas fa-users"></i></div>
            <div class="nav-text">Пользователи</div>
        </div>
        <div class="nav-item">
            <div class="nav-icon"><i class="fas fa-chart-pie"></i></div>
            <div class="nav-text">Аналитика</div>
        </div>
        <div class="nav-item">
            <div class="nav-icon"><i class="fas fa-cog"></i></div>
            <div class="nav-text">Настройки</div>
        </div>
    </div>
    
    <!-- Основной контент -->
    <div class="main-content">
        <div class="header">
            <h1><i class="fas fa-file-contract"></i> Управление заявками</h1>
            <div class="user-info">
                <div class="user-avatar">A</div>
                <div>
                    <div>Администратор</div>
                    <div style="font-size: 14px; color: var(--secondary);">admin@company.com</div>
                </div>
            </div>
        </div>
        
        <!-- Карточки статистики -->
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon" style="background: #e3f2fd; color: #1976d2;"><i class="fas fa-inbox"></i></div>
                <div class="stat-text">
                    <h3>Всего заявок</h3>
                    <h2>128</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #e8f5e9; color: #388e3c;"><i class="fas fa-eye"></i></div>
                <div class="stat-text">
                    <h3>Просмотрено</h3>
                    <h2>84</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fff8e1; color: #ffa000;"><i class="fas fa-clock"></i></div>
                <div class="stat-text">
                    <h3>Новых сегодня</h3>
                    <h2>7</h2>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: #fbe9e7; color: #d84315;"><i class="fas fa-calendar-week"></i></div>
                <div class="stat-text">
                    <h3>За неделю</h3>
                    <h2>24</h2>
                </div>
            </div>
        </div>
        
        <!-- Таблица заявок -->
        <div class="submissions-card">
            <div class="card-header">
                <h2><i class="fas fa-list"></i> Список заявок</h2>
                <div class="search-container">
                    <input type="text" class="search-box" placeholder="Поиск по имени, email или UUID...">
                    <button class="btn btn-outline"><i class="fas fa-filter"></i> Фильтры</button>
                    <button class="btn btn-primary"><i class="fas fa-file-export"></i> Экспорт</button>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Пользователь</th>
                        <th>Контакт</th>
                        <th>Дата</th>
                        <th>UUID</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="submissionsTable">
                    <!-- Данные будут заполнены через JavaScript -->
                </tbody>
            </table>
            
            <!-- Пагинация -->
            <div class="pagination-container">
                <button class="pagination-btn disabled" id="prevPageBtn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <div class="pagination-info" id="paginationInfo">Страница 1 из 6</div>
                
                <button class="pagination-btn" id="nextPageBtn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра сообщения -->
<div class="modal" id="messageModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title"><i class="fas fa-file-alt"></i> Детали заявки</div>
            <button class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="submission-details">
                <div class="detail-item">
                    <h4><i class="fas fa-user"></i> Имя</h4>
                    <p id="modal-name">Иван Иванов</p>
                </div>
                <div class="detail-item">
                    <h4><i class="fas fa-envelope"></i> Email</h4>
                    <p id="modal-email">ivan@mail.ru</p>
                </div>
                <div class="detail-item">
                    <h4><i class="fas fa-phone"></i> Телефон</h4>
                    <p id="modal-phone">+7 (999) 123-45-67</p>
                </div>
                <div class="detail-item">
                    <h4><i class="fas fa-calendar"></i> Дата отправки</h4>
                    <p id="modal-date">2023-10-15 14:30</p>
                </div>
                <div class="detail-item">
                    <h4><i class="fas fa-tag"></i> Статус</h4>
                    <div class="status-select-container" data-status="new">
                        <select id="modal-status" class="status-select">
                            <option value="new">Новая</option>
                            <option value="viewed">Просмотрено</option>
                            <option value="in_progress">В работе</option>
                            <option value="completed">Завершено</option>
                            <option value="rejected">Отклонено</option>
                        </select>
                    </div>
                </div>
                <div class="detail-item uuid-container">
                    <h4><i class="fas fa-fingerprint"></i> UUID заявки</h4>
                    <div class="uuid-display">
                        <div class="uuid-value" id="modal-uuid">550e8400-e29b-41d4-a716-446655440000</div>
                        <button class="copy-btn" id="copyUuidBtn">
                            <i class="fas fa-copy"></i> Копировать
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="message-container">
                <h4><i class="fas fa-comment"></i> Сообщение</h4>
                <div class="message-content" id="modal-message">
                    Здравствуйте, меня интересуют условия сотрудничества с вашей компанией. Хотел бы уточнить несколько моментов по поводу тарифных планов и дополнительных услуг. В частности, меня интересует:
                    1. Возможность интеграции с нашей внутренней CRM системой
                    2. Наличие API для автоматизации процессов
                    3. Условия технической поддержки в нерабочее время
                    4. Стоимость дополнительных модулей
                    
                    Также хотел бы узнать о текущих акциях и скидках для новых клиентов. Наш бизнес связан с оптовыми продажами, и мы рассматриваем долгосрочное сотрудничество.
                    
                    Прошу выслать коммерческое предложение с детализацией услуг. Также буду благодарен за возможность организовать онлайн-демонстрацию вашего продукта для нашей команды.
                    
                    Заранее спасибо за оперативный ответ!
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline"><i class="fas fa-reply"></i> Ответить</button>
            <button class="btn btn-primary close-modal"><i class="fas fa-times"></i> Закрыть</button>
        </div>
    </div>
</div>

<!-- Уведомление о копировании -->
<div class="copied-notification" id="copiedNotification">
    <i class="fas fa-check-circle"></i> UUID скопирован в буфер обмена!
</div>

<script>
    // Генератор UUID v4
    function uuidv4() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    
    // Генерация тестовых данных
    function generateSampleData(count) {
        const names = ["Иван Иванов", "Петр Петров", "Мария Сидорова", "Алексей Козлов", "Елена Федорова", 
                        "Дмитрий Смирнов", "Ольга Новикова", "Сергей Кузнецов", "Анна Морозова", "Николай Волков",
                        "Татьяна Лебедева", "Андрей Соловьев", "Юлия Васильева", "Михаил Зайцев", "Наталья Павлова"];
        
        const emails = ["ivan@mail.ru", "petrov@gmail.com", "msidorova@yandex.ru", "akozlov@mail.com", "efedorova@gmail.com",
                        "dsmirnov@company.com", "onovikova@mail.ru", "skuznetsov@gmail.com", "amorozova@yandex.ru", "nvolkov@mail.com"];
        
        const phones = ["+7 (999) 123-45-67", "+7 (912) 345-67-89", null, "+7 (905) 123-45-67", "+7 (913) 987-65-43",
                        "+7 (915) 111-22-33", "+7 (916) 444-55-66", "+7 (917) 777-88-99", "+7 (918) 000-11-22", "+7 (919) 333-44-55"];
        
        const messages = [
            "Здравствуйте, меня интересуют условия сотрудничества с вашей компанией. Хотел бы уточнить несколько моментов по поводу...",
            "Добрый день! Хочу выразить благодарность за отличный сервис. Особенно хочу отметить работу менеджера Марии...",
            "Прошу предоставить дополнительную информацию о ваших продуктах. Меня интересует возможность интеграции...",
            "Добрый вечер! Столкнулся с проблемой при использовании вашего сервиса. После обновления перестала работать функция...",
            "Интересует вопрос о возможности индивидуального подхода к разработке решения для нашей компании. У нас есть особые требования...",
            "Хотел бы получить консультацию по выбору оптимального тарифного плана для нашего бизнеса. У нас штат из 50 сотрудников...",
            "Прошу связаться со мной для уточнения деталей доставки заказа. Заказ был сделан вчера, номер заказа #4587...",
            "Предлагаю рассмотреть возможность партнерства. Наша компания специализируется на разработке программного обеспечения...",
            "Пишу по поводу вакансии Frontend разработчика. Отправил резюме на прошлой неделе, хотел бы узнать статус рассмотрения...",
            "Обнаружил ошибку в работе личного кабинета. При попытке загрузки документа система выдает ошибку 500..."
        ];
        
        const data = [];
        
        for (let i = 0; i < count; i++) {
            const name = names[Math.floor(Math.random() * names.length)];
            const email = emails[Math.floor(Math.random() * emails.length)];
            const phone = phones[Math.floor(Math.random() * phones.length)];
            const message = messages[Math.floor(Math.random() * messages.length)];
            const timestamp = `2023-10-${Math.floor(Math.random() * 15) + 10} ${Math.floor(Math.random() * 10) + 10}:${Math.floor(Math.random() * 60)}`;
            const status = Math.random() > 0.3 ? "viewed" : "new";
            const uuid = uuidv4();
            
            data.push({
                id: i + 1,
                name,
                email,
                phone,
                message,
                timestamp,
                status,
                uuid
            });
        }
        
        return data;
    }
    
    // Конфигурация пагинации
    const PAGE_SIZE = 10;
    let currentPage = 1;
    let submissionsData = generateSampleData(58); // Генерируем 58 тестовых заявок
    
    // Функция отрисовки таблицы
    function renderTable(page) {
        const startIndex = (page - 1) * PAGE_SIZE;
        const endIndex = Math.min(startIndex + PAGE_SIZE, submissionsData.length);
        const pageData = submissionsData.slice(startIndex, endIndex);
        
        const tableBody = document.getElementById("submissionsTable");
        tableBody.innerHTML = "";
        
        pageData.forEach(submission => {
            const row = document.createElement("tr");
            
            // Генерация инициалов для аватара
            const initials = submission.name.split(" ")
                .map(part => part[0])
                .join("")
                .toUpperCase();
            
            // Форматирование телефона
            const phoneDisplay = submission.phone ? submission.phone : "не указан";
            
            // Сокращение UUID для таблицы
            const shortUuid = submission.uuid.substring(0, 8) + "...";
            
            // Определение текста статуса
            let statusText;
            switch(submission.status) {
                case "new": statusText = "Новая"; break;
                case "viewed": statusText = "Просмотрено"; break;
                case "in_progress": statusText = "В работе"; break;
                case "completed": statusText = "Завершено"; break;
                case "rejected": statusText = "Отклонено"; break;
                default: statusText = "Неизвестно";
            }
            
            row.innerHTML = `
                <td>
                    <div class="user-cell">
                        <div class="user-avatar-small">${initials}</div>
                        <div>${submission.name}</div>
                    </div>
                </td>
                <td>
                    <div>${submission.email}</div>
                    <div style="font-size: 14px; color: var(--secondary);">${phoneDisplay}</div>
                </td>
                <td>${submission.timestamp}</td>
                <td>
                    <div class="uuid-badge" title="${submission.uuid}">
                        <i class="fas fa-fingerprint"></i>${shortUuid}
                    </div>
                </td>
                <td>
                    <span class="status-badge status-${submission.status}">
                        ${statusText}
                    </span>
                </td>
                <td>
                    <button class="action-btn view-btn" data-id="${submission.id}">
                        <i class="fas fa-eye"></i> Просмотр
                    </button>
                </td>
            `;
            
            tableBody.appendChild(row);
        });
        
        // Обновление информации о пагинации
        const totalPages = Math.ceil(submissionsData.length / PAGE_SIZE);
        document.getElementById("paginationInfo").textContent = `Страница ${page} из ${totalPages}`;
        
        // Обновление состояния кнопок
        document.getElementById("prevPageBtn").classList.toggle("disabled", page === 1);
        document.getElementById("nextPageBtn").classList.toggle("disabled", page === totalPages);
        
        // Добавление обработчиков событий для кнопок просмотра
        document.querySelectorAll('.view-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                const submission = submissionsData.find(s => s.id === id);
                
                if (submission) {
                    // Сохраняем ID текущей заявки в модальном окне
                    const modal = document.getElementById('messageModal');
                    modal.dataset.currentId = id;
                    
                    // Заполняем данные в модальном окне
                    document.getElementById('modal-name').textContent = submission.name;
                    document.getElementById('modal-email').textContent = submission.email;
                    document.getElementById('modal-phone').textContent = submission.phone || "не указан";
                    document.getElementById('modal-date').textContent = submission.timestamp;
                    document.getElementById('modal-uuid').textContent = submission.uuid;
                    document.getElementById('modal-message').textContent = submission.message;
                    
                    // Устанавливаем текущий статус
                    document.getElementById('modal-status').value = submission.status;
                    
                    // Открываем модальное окно
                    modal.style.display = 'flex';
                }
            });
        });
        
        // Обработчики для UUID-баджей
        document.querySelectorAll('.uuid-badge').forEach(badge => {
            badge.addEventListener('click', function() {
                const uuid = this.getAttribute('title');
                copyToClipboard(uuid);
                showNotification('UUID скопирован в буфер обмена!');
            });
        });
    }
    
    // Функция копирования в буфер обмена
    function copyToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
    }
    
    // Показать уведомление
    function showNotification(message) {
        const notification = document.getElementById('copiedNotification');
        notification.textContent = message;
        notification.style.opacity = 0;
        
        // Перезапуск анимации
        notification.style.animation = 'none';
        setTimeout(() => {
            notification.style.animation = 'fadeInOut 2s ease';
        }, 10);
    }
    
    // Инициализация пагинации
    document.getElementById("prevPageBtn").addEventListener("click", function() {
        if (currentPage > 1) {
            currentPage--;
            renderTable(currentPage);
        }
    });
    
    document.getElementById("nextPageBtn").addEventListener("click", function() {
        const totalPages = Math.ceil(submissionsData.length / PAGE_SIZE);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable(currentPage);
        }
    });
    
    // Обработчики для открытия/закрытия модального окна
    document.querySelectorAll('.close-btn, .close-modal').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('messageModal').style.display = 'none';
        });
    });
    
    // Закрытие модального окна при клике вне его области
    window.addEventListener('click', function(event) {
        if (event.target === document.getElementById('messageModal')) {
            document.getElementById('messageModal').style.display = 'none';
        }
    });
    
    // Копирование UUID в модальном окне
    document.getElementById('copyUuidBtn').addEventListener('click', function() {
        const uuid = document.getElementById('modal-uuid').textContent;
        copyToClipboard(uuid);
        showNotification('UUID скопирован в буфер обмена!');
    });
    
    document.getElementById('modal-status').addEventListener('change', function() {
        const modal = document.getElementById('messageModal');
        const submissionId = parseInt(modal.dataset.currentId);
        const newStatus = this.value;
        
        const submissionIndex = submissionsData.findIndex(s => s.id === submissionId);
        if (submissionIndex !== -1) {
            submissionsData[submissionIndex].status = newStatus;
            
            // Перерисовываем таблицу
            renderTable(currentPage);
            
            // Показываем уведомление об успешном изменении
            showNotification('Статус успешно обновлен!');
        }
    });
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        renderTable(currentPage);
    });
</script>
</body>
</html>